# iOS 14.0 ì´ìƒ ì§€ì› (Xcode 16.3 ê¶Œì¥)
platform :ios, '14.0'

# CocoaPods í†µê³„ ê¸°ëŠ¥ ë¹„í™œì„±í™” = Flutter ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

# Firebase SDK ë²„ì „ ê³ ì • (Xcode 16 í˜¸í™˜ì„±)
$FirebaseSDKVersion = '10.18.0'

# ê° ë¹Œë“œ ëª¨ë“œë³„ êµ¬ì„±
project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

# Flutter ë£¨íŠ¸ ê²½ë¡œ ì„¤ì •: Generated.xcconfig íŒŒì¼ì„ í†µí•´ FLUTTER_ROOT í™˜ê²½ ë³€ìˆ˜ ì½ì–´ì˜´
def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  # Generated.xcconfig íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ ë°œìƒ (flutter pub get ì‹¤í–‰ í•„ìš”)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end

  # Generated.xcconfig íŒŒì¼ì—ì„œ FLUTTER_ROOT í™˜ê²½ ë³€ìˆ˜ ì¶”ì¶œ
  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

# flutter_tools íŒ¨í‚¤ì§€ì˜ podhelper ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ
require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

flutter_ios_podfile_setup

target 'Runner' do
  # í”„ë ˆì„ì›Œí¬ ì‚¬ìš© í™œì„±í™”
  use_frameworks!
  # ëª¨ë“ˆí™” í—¤ë” ì‚¬ìš© í™œì„±í™”
  use_modular_headers!
  
  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  
  target 'RunnerTests' do
    inherit! :search_paths
  end
end

# CocoaPodsê°€ ëª¨ë“  ì˜ì¡´ì„± ì„¤ì¹˜ë¥¼ ì™„ë£Œí•œ í›„ ì‹¤í–‰ë˜ëŠ” í›…
post_install do |installer|
  # í”„ë¡œì íŠ¸ ë‚´ ì„¤ì¹˜ëœ ëª¨ë“  pod(ë¼ì´ë¸ŒëŸ¬ë¦¬)ë¥¼ íƒ€ê²Ÿìœ¼ë¡œ í•˜ì—¬ ë°˜ë³µí•¨
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
    
    target.build_configurations.each do |config|
      # iOS ë°°í¬ íƒ€ê²Ÿ ì„¤ì •
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'

      # ========== Xcode 16.3 ê¸°ë³¸ í˜¸í™˜ì„± ì„¤ì • ==========
      # ì „ì—­ ë¹Œë“œ ì„¤ì •
      config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'NO'
      config.build_settings['VALIDATE_WORKSPACE'] = 'NO'
      
      # C++ í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
      config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++20'
      config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
      
      # ê²½ê³ ë¥¼ ì˜¤ë¥˜ë¡œ ì·¨ê¸‰í•˜ì§€ ì•Šë„ë¡ ì„¤ì •
      config.build_settings['GCC_TREAT_WARNINGS_AS_ERRORS'] = 'NO'
      config.build_settings['CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER'] = 'NO'
      config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'
      config.build_settings['CLANG_WARN_DOCUMENTATION_COMMENTS'] = 'NO'

      # ========== Swift/Objective-C ë¸Œë¦¬ì§• ì „ì—­ ì„¤ì • ==========
      # Swift ëª¨ë“ˆ ì¸í„°í˜ì´ìŠ¤ ë¹„í™œì„±í™” (Xcode 16 ì¶©ëŒ ë°©ì§€)
      config.build_settings['SWIFT_EMIT_MODULE_INTERFACE'] = 'NO'
      config.build_settings['SWIFT_ENABLE_BATCH_MODE'] = 'NO'
      
      # ========== ì½”ë“œ ì„œëª… ì„¤ì • ==========
      # í”„ë ˆì„ì›Œí¬ íƒ€ì… ì œí’ˆì— ëŒ€í•˜ì—¬ ì½”ë“œ ì„œëª… ë¹„í™œì„±í™”
      if target.respond_to?(:product_type) and target.product_type == "com.apple.product-type.framework"
        config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
        config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
        config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
      end

      # ========== ê¶Œí•œ ì„¤ì • ==========
      config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= [
        '$(inherited)',
        'PERMISSION_CAMERA=1',           # ì¹´ë©”ë¼ ê¶Œí•œ í™œì„±í™”
        'PERMISSION_PHOTOS=1',           # ì‚¬ì§„ ê¶Œí•œ í™œì„±í™”
        'PERMISSION_PHOTOS_ADD_ONLY=1',  # ì‚¬ì§„ ì¶”ê°€ ê¶Œí•œ í™œì„±í™”
        'PERMISSION_LOCATION=1',         # ìœ„ì¹˜ ê¶Œí•œ í™œì„±í™” (geolocatorìš©)
      ]
      
      # ========== Firebase ê´€ë ¨ íŠ¹ë³„ ì²˜ë¦¬ ==========
      firebase_targets = ['FirebaseCore', 'FirebaseAuth', 'FirebaseFirestore', 'FirebaseStorage', 'FirebaseAppCheck']
      
      if firebase_targets.any? { |name| target.name.include?(name) }
        # FirebaseëŠ” ëª¨ë“ˆ ì‹œìŠ¤í…œ í•„ìˆ˜ì´ë¯€ë¡œ í™œì„±í™” ìœ ì§€
        config.build_settings['DEFINES_MODULE'] = 'YES'
        config.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
        
        # í•˜ì§€ë§Œ Swift ë¸Œë¦¬ì§• í—¤ë”ëŠ” ë¹„ì›Œë‘ 
        config.build_settings['SWIFT_OBJC_BRIDGING_HEADER'] = ''
        config.build_settings['SWIFT_OBJC_INTERFACE_HEADER_NAME'] = ''
        
        # Firebase íŠ¹í™” ì„¤ì •
        config.build_settings['VALIDATE_PRODUCT'] = 'NO'
        config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
        
        puts "Applied Firebase-compatible settings to #{target.name}"
      end
      
      # ========== ë¬¸ì œê°€ ìˆëŠ” C++ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²˜ë¦¬ ==========
      # Firebase ê´€ë ¨ì´ ì•„ë‹Œ C++ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ë§Œ ëª¨ë“ˆ ë¹„í™œì„±í™”
      problematic_cpp_targets = ['abseil', 'gRPC-Core', 'BoringSSL-GRPC', 'gRPC-C++', 'leveldb-library', 'nanopb', 'Protobuf-C++']
      
      if problematic_cpp_targets.any? { |name| target.name.include?(name) } && !firebase_targets.any? { |name| target.name.include?(name) }
        # ì´ëŸ¬í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ì€ ëª¨ë“ˆí™” ë¹„í™œì„±í™”
        config.build_settings['DEFINES_MODULE'] = 'NO'
        config.build_settings['CLANG_ENABLE_MODULES'] = 'NO'
        config.build_settings['SWIFT_EMIT_MODULE_INTERFACE'] = 'NO'
        
        # í—¤ë” ê²€ìƒ‰ ê²½ë¡œ ìµœì í™”
        config.build_settings['HEADER_SEARCH_PATHS'] ||= '$(inherited)'
        config.build_settings['USER_HEADER_SEARCH_PATHS'] ||= '$(inherited)'
        
        puts "Applied C++ library settings to #{target.name}"
      end
      
      # ========== flutter_secure_storage íŠ¹ë³„ ì²˜ë¦¬ ==========
      if target.name == 'flutter_secure_storage'
        # Swift ë¸Œë¦¬ì§• í—¤ë” ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì„¤ì •
        config.build_settings['DEFINES_MODULE'] = 'YES'
        config.build_settings['SWIFT_OBJC_INTERFACE_HEADER_NAME'] = 'flutter_secure_storage-Swift.h'
        config.build_settings['SWIFT_INSTALL_OBJC_HEADER'] = 'YES'
        config.build_settings['SWIFT_OBJC_BRIDGING_HEADER'] = ''
        
        puts "Applied Swift bridging settings to flutter_secure_storage"
      end
      
      # ========== ì‹œë®¬ë ˆì´í„° ì•„í‚¤í…ì²˜ ì„¤ì • ==========
      # M1/M2 Macì˜ iOS ì‹œë®¬ë ˆì´í„° í˜¸í™˜ì„± (í•„ìš”ì‹œ í™œì„±í™”)
      # config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
    end
  end
  
  # ========== í”„ë¡œì íŠ¸ ë ˆë²¨ ì„¤ì • ==========
  installer.pods_project.build_configurations.each do |config|
    # ì „ì²´ í”„ë¡œì íŠ¸ì— Xcode 16 í˜¸í™˜ì„± ì ìš©
    config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'NO'
    config.build_settings['VALIDATE_WORKSPACE'] = 'NO'
  end
  
  puts "âœ… Xcode 16.3 + Firebase í˜¸í™˜ì„± ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."
  puts "ğŸ“± iOS 14.0+ íƒ€ê²Ÿìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
  puts "ğŸ”¥ Firebase ëª¨ë“ˆ ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
end